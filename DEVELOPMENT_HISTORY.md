# Hist√≥rico de Desarrollo - Dashboard EPMAPS POC

Este archivo documenta todas las instrucciones, cambios y evoluci√≥n del proyecto para poder retomar el desarrollo en cualquier punto.

## Contexto del Proyecto

**Objetivo**: Crear una aplicaci√≥n con Streamlit que viva dentro de AWS para monitoreo de salud de m√°quinas virtuales, con capacidad de expansi√≥n futura para reportes, tendencias, etc.

**Tecnolog√≠as**:
- Streamlit (framework principal)
- Boto3 (AWS SDK para Python)
- Docker (Contenedores)
- AWS App Runner / EC2 (Despliegue Serverless / Instancia)
- GitHub Actions (CI/CD)
- YAML (Configuraci√≥n)

## Registro de Desarrollo

### 2025-09-14 - SAP Availability Integration with Real CloudWatch Logs Data

#### Objective
Complete the integration of SAP availability monitoring by connecting to real CloudWatch Logs data generated by Lambda functions, implementing proper log parsing for the FILE_CHECK_DETAIL format.

#### Problems Encountered & Solutions
1. **Log Group Names Update**:
   * **Problem:** Previous implementation used placeholder log group names that didn't match the actual Lambda function log groups.
   * **Solution:** Updated `get_sap_availability_data()` to use the real log group names:
     - Production: `/aws/lambda/sap-availability-heartbeat-prod` and `/aws/lambda/sap-availability-heartbeat-prod-b`
     - QA/DEV: `/aws/lambda/sap-availability-heartbeat` and `/aws/lambda/sap-availability-heartbeat-b`

2. **Log Format Mismatch**:
   * **Problem:** Parser was designed for generic log format but actual logs use structured JSON format with FILE_CHECK_DETAIL prefix.
   * **Solution:** Completely rewrote `parse_sap_log_results()` to parse the actual format:
     ```
     FILE_CHECK_DETAIL: {"vm_name": "...", "instance_id": "...", "file_path": "...", 
                        "status": "AVAILABLE/UNAVAILABLE", "details": "...", 
                        "raw_output": "...", "timestamp": "...", "environment": "..."}
     ```

3. **Environment-Based Log Group Selection**:
   * **Problem:** Need to query different log groups based on whether instance is production or development.
   * **Solution:** Implemented logic to detect production instances by checking for 'PRD', 'PROD', or 'PRODUCTION' patterns in instance names and select appropriate log groups.

4. **Service Name Extraction**:
   * **Problem:** Need to extract meaningful service names from SAP file paths like `/usr/sap/DAA/SMDA98/work/available.log`.
   * **Solution:** Used regex to parse file paths and create service names like "DAA SMDA98" from the path components.

#### Files Modified:
* `app.py`:
  - Updated `get_sap_availability_data()` function with real log group names and environment detection
  - Completely rewrote `parse_sap_log_results()` to handle FILE_CHECK_DETAIL JSON format
  - Enhanced `create_sap_availability_table()` to display new data fields (environment, details, raw_output, etc.)
* `config.yaml`:
  - Bumped version to v0.1.67

#### Implementation Details:
* **Environment Detection**: Automatically determines if instance is production or development based on naming patterns
* **JSON Parsing**: Handles malformed JSON by attempting to fix common issues like double quotes
* **Service Identification**: Extracts SAP system and instance numbers from file paths
* **Rich Data Display**: Shows status, details, raw output, environment, and timestamp information
* **Error Handling**: Comprehensive logging for debugging CloudWatch Logs issues

#### Technical Improvements:
* More robust JSON parsing with error recovery
* Better service name extraction using regex patterns
* Environment-aware log group selection
* Enhanced error logging for troubleshooting

### 2025-09-12 - Continuous Deployment and Data Loading Fixes

#### Objective
Establish a robust CI/CD pipeline for deploying the Streamlit app to EC2 and resolve data loading issues.

#### Problems Encountered & Solutions
1.  **GitHub Actions Permission Denied (`fatal: failed to stat ... Permission Denied`)**:
    *   **Problem:** The `ssm-user` running the SSM command in GitHub Actions could not access the application directory (`APP_PATH`), and the `ec2-user` (intended owner) also lacked permissions.
    *   **Solution:** Modified `deploy.yml` to ensure the application directory (`/home/ec2-user/POC-Dashboard`) is created and owned by `ec2-user` *before* any `git` operations.
2.  **GitHub Actions `fatal: not a git repository`**:
    *   **Problem:** After fixing permissions, the `git pull` command failed because the newly created directory on EC2 was not a Git repository.
    *   **Solution:** Modified `deploy.yml` to include `git init` and `git remote add origin` before `git pull`, ensuring the directory is a proper Git repository.
3.  **GitHub Actions `remote origin already exists`**:
    *   **Problem:** On subsequent deployments, `git remote add origin` failed because the remote was already configured.
    *   **Solution:** Modified `deploy.yml` to conditionally add the remote origin, checking if it exists first.
4.  **Streamlit App "No se puede acceder a este sitio web"**:
    *   **Problem:** The Streamlit service was crashing on startup (`status=200/CHDIR`) because its `WorkingDirectory` in `/etc/systemd/system/streamlit.service` was pointing to the old path (`/home/ssm-user/POC-Dashboard/`).
    *   **Solution:** Updated the `streamlit.service` file on EC2 to set `WorkingDirectory=/home/ec2-user/POC-Dashboard`, reloaded `systemd` daemon, and restarted the service.
5.  **Streamlit App "Cargando datos desde AWS..." (Data Loading Issue)**:
    *   **Problem:** The application was stuck on the loading message, and logs showed `botocore.client.EC2` objects were not pickle-serializable, causing `st.cache_data` to fail in `get_cross_account_boto3_client()`.
    *   **Solution:** Changed `@st.cache_data` to `@st.cache_resource` for `get_cross_account_boto3_client()` in `app.py`, as recommended by Streamlit for non-serializable objects.
6.  **Lack of Real-time Data Refresh & Debugging Visibility**:
    *   **Problem:** The page was not auto-reloading, and debugging AWS data fetching issues was difficult without on-screen logs.
    *   **Solution:**
        *   Implemented a configurable auto-reload mechanism with a countdown timer in `app.py` (using `REFRESH_INTERVAL_SECONDS` from `config.yaml`).
        *   Added a `show_aws_errors` flag to `config.yaml` to control on-screen display of AWS errors.
        *   Enhanced `get_aws_data()` with more granular logging to `/tmp/streamlit_aws_debug.log`.
        *   Implemented a feature to display the content of `/tmp/streamlit_aws_debug.log` directly on the Streamlit page when `show_aws_errors` is enabled.

#### Files Modified:
*   `.github/workflows/deploy.yml`
*   `app.py`
*   `config.yaml`

### 2025-09-12 - Versi√≥n 6.1: Simplificaci√≥n de Navegaci√≥n - Solo POC AWS Alive

#### Resumen
Se simplific√≥ la navegaci√≥n de la aplicaci√≥n para mostrar √∫nicamente la p√°gina "POC AWS Alive" en el sidebar, ocultando todas las p√°ginas auxiliares y de entornos de prueba (Production, QA, DEV). La aplicaci√≥n ahora redirige autom√°ticamente a POC AWS Alive al iniciar.

#### Cambios Implementados

1. **Redirecci√≥n Autom√°tica en `app.py`**:
   * Se elimin√≥ el sidebar manual con m√∫ltiples enlaces
   * Se implement√≥ redirecci√≥n autom√°tica a POC AWS Alive usando `st.switch_page()`
   * Se configur√≥ `initial_sidebar_state="collapsed"` para ocultar el sidebar por defecto

2. **Renombrado de P√°gina Principal**:
   * `pages/4_POC.py` ‚Üí `pages/POC_AWS_Alive.py`
   * Esto elimina el prefijo num√©rico y mejora la claridad del nombre

3. **Actualizaci√≥n de Referencias de Navegaci√≥n**:
   * Se actualizaron todas las referencias en `_5_POC_Detalles.py` para apuntar a `POC_AWS_Alive.py`
   * Las p√°ginas con prefijo `_` permanecen ocultas del sidebar como es esperado

#### Justificaci√≥n
El usuario report√≥ que las p√°ginas con prefijo `_` segu√≠an apareciendo en el sidebar debido al uso de navegaci√≥n manual con `st.sidebar.page_link()`. Al eliminar esta navegaci√≥n manual y usar el comportamiento autom√°tico de Streamlit, solo las p√°ginas sin prefijo `_` son visibles, logrando el objetivo de mostrar √∫nicamente POC AWS Alive.

### 2025-09-12 - Versi√≥n 6.0 (Beta 2): Refactorizaci√≥n Arquitect√≥nica y Despliegue Automatizado

#### Resumen
Esta versi√≥n representa la refactorizaci√≥n m√°s grande hasta la fecha. La aplicaci√≥n monol√≠tica (`app.py`) fue desmantelada y reconstruida sobre una arquitectura modular, escalable y configurable, alineada con las mejores pr√°cticas de desarrollo de software. Adem√°s, se implement√≥ un flujo de despliegue continuo (CI/CD).

#### Cambios Implementados

1.  **Arquitectura Multi-P√°gina y Componentizada**:
    *   La aplicaci√≥n se transform√≥ en una **aplicaci√≥n multi-p√°gina**, con archivos dedicados para cada entorno (`Producci√≥n`, `QA`, `DEV`) en el directorio `pages/`.
    *   Se crearon **componentes de UI reutilizables** (`server_card.py`, `group_container.py`) para encapsular la l√≥gica de renderizado y promover la reutilizaci√≥n de c√≥digo.
    *   La l√≥gica com√∫n y funciones de ayuda se centralizaron en `utils/helpers.py`.

2.  **Configuraci√≥n Externa con `config.yaml`**:
    *   Toda la definici√≥n de servidores, grupos y estados se movi√≥ a un archivo `config.yaml`.
    *   **Beneficio:** Ahora es posible a√±adir, modificar o eliminar servidores y grupos sin necesidad de editar el c√≥digo Python, facilitando enormemente el mantenimiento.

3.  **Mejoras de Navegaci√≥n y Experiencia de Usuario**:
    *   `app.py` ahora funciona como un **portal de bienvenida** que construye una barra de navegaci√≥n lateral personalizada, ofreciendo una experiencia m√°s limpia.
    *   Se a√±adi√≥ un **navegador entre entornos** (flechas ·êä y ·êÖ) en las p√°ginas principales.
    *   La navegaci√≥n a las p√°ginas de detalle fue refactorizada para usar **par√°metros de consulta en la URL** (`st.query_params`), un m√©todo m√°s robusto y est√°ndar que `st.session_state`.

4.  **Optimizaci√≥n de la P√°gina POC (AWS Live)**:
    *   La p√°gina `4_POC.py` fue redise√±ada para usar un **sistema de cache en memoria compartida**.
    *   Un **hilo de fondo (background thread)** se encarga de actualizar los datos desde AWS (`boto3`) cada 30 segundos.
    *   **Beneficio:** Todos los usuarios concurrentes acceden a la misma cache, lo que reduce dr√°sticamente las llamadas a la API de AWS, mejora el rendimiento y la escalabilidad de la aplicaci√≥n.

5.  **Despliegue Continuo con GitHub Actions**:
    *   Se cre√≥ el flujo de trabajo `.github/workflows/deploy.yml`.
    *   Este flujo **automatiza el despliegue** de la aplicaci√≥n en la instancia EC2 designada cada vez que se realiza un `push` a la rama `main`.
    *   Utiliza `AWS SSM Send-Command` para ejecutar los comandos de actualizaci√≥n en la instancia de forma segura.

#### Decisi√≥n de Arquitectura
Se adopt√≥ una arquitectura modular y basada en configuraci√≥n para preparar la aplicaci√≥n para un crecimiento futuro. La separaci√≥n de la configuraci√≥n (`config.yaml`), la l√≥gica (`utils/`), los componentes de UI (`components/`) y las vistas (`pages/`) hace que el sistema sea m√°s f√°cil de entender, mantener y escalar. La implementaci√≥n de CI/CD con GitHub Actions profesionaliza el ciclo de vida del desarrollo.

### 2025-09-10 - Versi√≥n 5.0 (Beta 1): Modernizaci√≥n y Preparaci√≥n para Despliegue

#### Resumen
En esta fase, la aplicaci√≥n fue refactorizada en profundidad para eliminar dependencias de herramientas de l√≠nea de comandos (`aws-cli`) y adoptar una arquitectura moderna, robusta y portable, lista para un despliegue profesional en la nube.

#### Cambios Implementados

1.  **Refactorizaci√≥n a `boto3`**:
    *   Se reemplazaron todas las llamadas a `subprocess` que ejecutaban `aws-cli`.
    *   Toda la comunicaci√≥n con AWS (EC2 y CloudWatch) ahora se realiza de forma nativa en Python a trav√©s de la librer√≠a `boto3`.
    *   **Beneficios:** Mayor rendimiento, c√≥digo m√°s limpio, mejor manejo de errores y eliminaci√≥n de una dependencia externa del entorno de ejecuci√≥n.

2.  **Contenerizaci√≥n con Docker**:
    *   Se a√±adi√≥ un `Dockerfile` a la ra√≠z del proyecto.
    *   Este archivo permite empaquetar la aplicaci√≥n y todas sus dependencias en un contenedor est√°ndar, garantizando que funcione de la misma manera en cualquier entorno (local o en la nube).

3.  **Nueva Estrategia de Despliegue con AWS App Runner**:
    *   Se defini√≥ una nueva estrategia de despliegue recomendada que utiliza AWS App Runner, un servicio serverless.
    *   **Beneficios:** Costo-eficiencia (pago por uso, escala a cero), totalmente gestionado por AWS, y despliegue continuo desde el repositorio de c√≥digo.

4.  **Creaci√≥n de Documentaci√≥n de Despliegue**:
    *   Se cre√≥ un nuevo directorio `docs/`.
    *   Se a√±adieron dos gu√≠as de despliegue detalladas:
        *   `deploy_using_app_runner.md` (Recomendada)
        *   `deploy_using_ec2instance.md` (Alternativa)

5.  **Mejoras de Navegaci√≥n y UI**:
    *   Se corrigieron errores de navegaci√≥n a las p√°ginas de detalle.
    *   Se reestructur√≥ el directorio `pages/` para ocultar las p√°ginas de detalle de la barra lateral, limpiando el men√∫ principal.
    *   La aplicaci√≥n ahora carga directamente en la p√°gina de "Producci√≥n" para una mejor experiencia de usuario.

#### Decisi√≥n de Arquitectura
Se abandona el uso de `aws-cli` en favor de `boto3` para alinear el proyecto con las mejores pr√°cticas de desarrollo de aplicaciones en la nube, habilitando despliegues en contenedores y mejorando la mantenibilidad general del c√≥digo.

### 2025-09-10 - Inicio del Proyecto

#### Requerimientos Iniciales
El usuario solicit√≥ crear un POC con las siguientes caracter√≠sticas:

1. **P√°gina Principal**:
   - T√≠tulo: "Dashboard POC"
   - Grupo: "SAP ISU PRODUCCI√ìN"
   - 3 servidores virtuales:
     - SRVISUASCS (estado verde)
     - SRVISUPRD (estado rojo)
     - SRVISUPRDDB (estado amarillo)
   - Indicadores tipo sem√°foro para mostrar estado
   - Contador de alertas totales
   - Gr√°fico tipo pie mostrando alertas cr√≠ticas/advertencias/ok

2. **P√°gina de Detalle** (al hacer clic en una VM):
   - Columna 1: Listado gr√°fico de alarmas (luz + nombre)
   - Columna 2: 
     - Filtro de tiempo (5min, 15min, 30min, 1h, 3h, 6h, 12h)
     - Indicadores de CPU (1 por n√∫cleo)
     - Indicador de RAM
     - Indicadores de discos (5 discos)

#### Implementaci√≥n Realizada

**Archivos creados**:
1. `app.py` - Aplicaci√≥n principal con toda la l√≥gica
2. `requirements.txt` - Dependencias (streamlit, plotly)

**Caracter√≠sticas implementadas**:
- ‚úÖ Dashboard principal con 3 VMs
- ‚úÖ Estados de sem√°foro (verde, rojo, amarillo) con indicadores visuales
- ‚úÖ Contadores de alertas totales
- ‚úÖ Gr√°ficos de pie para distribuci√≥n de alertas
- ‚úÖ Navegaci√≥n a p√°gina de detalle por VM
- ‚úÖ Listado de alarmas con indicadores visuales
- ‚úÖ Filtro de tiempo
- ‚úÖ M√©tricas de CPU (4 n√∫cleos)
- ‚úÖ M√©trica de RAM
- ‚úÖ M√©tricas de 5 discos duros

**Decisiones t√©cnicas**:
- Uso de `st.session_state` para manejar navegaci√≥n entre vistas
- Datos hardcodeados para el POC
- Dise√±o responsive con columnas de Streamlit
- Plotly para gr√°ficos de pie compactos
- CSS inline para personalizar apariencia de sem√°foros

## Pr√≥ximos Pasos Sugeridos

1. **Integraci√≥n con AWS**:
   - Configurar despliegue en EC2/ECS/Lambda
   - Implementar autenticaci√≥n
   - Conectar con CloudWatch para m√©tricas reales

2. **Mejoras de Funcionalidad**:
   - Agregar persistencia de datos
   - Implementar actualizaci√≥n en tiempo real
   - A√±adir m√≥dulo de reportes
   - Implementar tendencias hist√≥ricas

3. **Mejoras de UI/UX**:
   - Tema oscuro/claro
   - Notificaciones push para alertas cr√≠ticas
   - Dashboard personalizable

## Notas para Retomar el Desarrollo

Para continuar el desarrollo:
1. Instalar dependencias: `pip install -r requirements.txt`
2. Ejecutar aplicaci√≥n: `streamlit run app.py`
3. Revisar este archivo para entender el contexto
4. Consultar README.md para ver el changelog actualizado

## Estructura del Proyecto (v6.0)

```
POC/
‚îú‚îÄ‚îÄ .github/                    # Flujos de trabajo de CI/CD
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml
‚îú‚îÄ‚îÄ app.py                      # P√°gina principal y navegador
‚îú‚îÄ‚îÄ config.yaml                 # Configuraci√≥n de servidores y grupos
‚îú‚îÄ‚îÄ Dockerfile                  # Contenerizaci√≥n de la aplicaci√≥n
‚îú‚îÄ‚îÄ requirements.txt            # Dependencias de Python
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ styles.css              # Hoja de estilos CSS
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ group_container.py      # Componente para grupos de servidores
‚îÇ   ‚îî‚îÄ‚îÄ server_card.py          # Componente para tarjetas de servidor
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ deploy_using_app_runner.md
‚îÇ   ‚îî‚îÄ‚îÄ deploy_using_ec2instance.md
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ 1_Production.py         # P√°gina para el entorno de Producci√≥n (oculta del men√∫)
‚îÇ   ‚îú‚îÄ‚îÄ 2_QA.py                 # P√°gina para el entorno de QA (oculta del men√∫)
‚îÇ   ‚îú‚îÄ‚îÄ 3_DEV.py                # P√°gina para el entorno de DEV (oculta del men√∫)
‚îÇ   ‚îú‚îÄ‚îÄ POC_AWS_Alive.py        # P√°gina principal con datos reales de AWS (√∫nica visible)
‚îÇ   ‚îú‚îÄ‚îÄ _1_Detalles_del_Servidor.py # P√°gina de detalle (oculta)
‚îÇ   ‚îú‚îÄ‚îÄ _5_POC_Detalles.py      # P√°gina de detalles POC (oculta)
‚îÇ   ‚îî‚îÄ‚îÄ _vm_details.py          # P√°gina de detalles VM (oculta)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ helpers.py              # Funciones de ayuda y l√≥gica compartida
‚îú‚îÄ‚îÄ DEVELOPMENT_HISTORY.md      # Este archivo
‚îî‚îÄ‚îÄ README.md                   # Documentaci√≥n principal
```

### 2025-09-10 - Segunda Iteraci√≥n: M√∫ltiples Grupos de Servidores

#### Nuevos Requerimientos
El usuario solicit√≥ agregar un segundo grupo de servidores:
- Grupo: "SAP ERP"
- 2 servidores:
  - SRVERPPRD (estado verde)
  - SRVSAPERPBDD (estado amarillo)
- Diferenciaci√≥n visual entre grupos mediante cajas

#### Cambios Implementados

**Modificaciones en app.py**:
1. Actualizaci√≥n de `get_vm_status()` para incluir los nuevos servidores
2. Actualizaci√≥n de `get_vm_alerts()` con datos para los nuevos servidores
3. Refactorizaci√≥n de `main_dashboard()` para mostrar dos grupos separados
4. Implementaci√≥n de cajas visuales diferenciadas:
   - SAP ISU PRODUCCI√ìN: Caja con borde azul (#1f77b4) y fondo azul claro
   - SAP ERP: Caja con borde naranja (#ff7f0e) y fondo naranja claro

**Caracter√≠sticas agregadas**:
- ‚úÖ Segundo grupo SAP ERP con 2 servidores
- ‚úÖ Cajas visuales para diferenciar grupos
- ‚úÖ Colores distintivos por grupo
- ‚úÖ Estados y alertas configurados para nuevos servidores

**Decisiones de dise√±o**:
- Uso de colores contrastantes pero armoniosos para diferenciar grupos
- Mantenimiento del layout de 3 columnas, dejando una vac√≠a en el grupo SAP ERP
- Conservaci√≥n del mismo estilo visual para los indicadores de estado

### 2025-09-10 - Tercera Iteraci√≥n: Estilizaci√≥n y Dise√±o Moderno

#### Requerimientos del Usuario
El usuario solicit√≥ estilizar la aplicaci√≥n para hacerla m√°s bonita e impactante visualmente.

#### Cambios Implementados

**Patr√≥n de Dise√±o Aplicado**: Glassmorphism + Futuristic Dark Theme

**Principales mejoras visuales**:
1. **Tema Oscuro Futurista**
   - Fondo con gradiente oscuro (#0a0f1c a #1a1f2e)
   - Efecto glassmorphism con backdrop-filter blur
   - Transparencias y bordes sutiles

2. **Animaciones y Efectos**
   - Animaci√≥n de pulso en indicadores de estado
   - Efectos hover en tarjetas (elevaci√≥n y brillo)
   - Transiciones suaves con cubic-bezier
   - Sombras din√°micas con colores de acento

3. **Mejoras Tipogr√°ficas**
   - Fuente Inter de Google Fonts
   - T√≠tulo principal con gradiente de texto
   - Jerarqu√≠a visual clara con tama√±os y pesos

4. **Componentes Redise√±ados**
   - Tarjetas de servidor con bordes gradiente al hover
   - Botones con gradientes y efectos de elevaci√≥n
   - Progress bars con gradientes vibrantes
   - Indicadores de estado con brillos y sombras de ne√≥n

5. **Nuevas Caracter√≠sticas Visuales**
   - Footer con resumen global del sistema
   - M√©tricas de disponibilidad con indicadores delta
   - Iconos para mejor identificaci√≥n visual
   - Colores vibrantes: cyan (#00d4ff), verde ne√≥n (#00ff88), morado (#667eea)

**Decisiones t√©cnicas**:
- CSS personalizado extenso para control total del dise√±o
- Uso de gradientes lineales para elementos destacados
- Animaciones CSS puras para mejor rendimiento

### 2025-09-14 - Eliminaci√≥n de Cach√© en Funciones de Detalle

#### Problema Identificado
Los usuarios reportaron que las alarmas aparec√≠an con estados diferentes entre la p√°gina de resumen y la p√°gina de detalle:
- P√°gina de resumen: Alarmas grises (INSUFFICIENT_DATA)
- P√°gina de detalle: Alarmas verdes (OK)

#### An√°lisis del Problema
Se identific√≥ que el problema era causado por el sistema de cach√©:
- La p√°gina de resumen no usaba cach√© y mostraba datos en tiempo real
- La p√°gina de detalle usaba `@st.cache_data(ttl=60)` con un TTL de 60 segundos
- Esto causaba que los datos pudieran tener hasta 60 segundos de antig√ºedad

#### Soluci√≥n Implementada
Se eliminaron todos los decoradores `@st.cache_data` de las funciones de obtenci√≥n de datos en la p√°gina de detalle:
- `get_instance_details()`
- `get_alarms_for_instance()`
- `get_cpu_utilization()`
- `get_memory_utilization()`
- `get_disk_utilization()`

Se mantuvo √∫nicamente el cach√© de los clientes boto3 (`@st.cache_resource(ttl=900)`) para evitar recrear las conexiones constantemente.

#### Justificaci√≥n
El sistema de monitoreo debe mostrar los problemas en tiempo real cuando se capturan. No debe haber informaci√≥n obsoleta o antigua que pueda causar confusi√≥n al momento de diagnosticar problemas.

#### Versi√≥n
Se actualiz√≥ la versi√≥n de la aplicaci√≥n de v0.1.56 a v0.1.57 para reflejar los cambios realizados en el sistema de cach√©.

### 2025-09-14 - Correcci√≥n de Estados UNKNOWN en Alarmas

#### Problema Identificado
Despu√©s de eliminar el cach√©, persist√≠a el problema de inconsistencia entre la p√°gina de resumen y la p√°gina de detalle. El servidor "SRVISUASCS" mostraba 6 alarmas todas verdes en la p√°gina de detalle, pero en el resumen aparec√≠an 5 verdes y 1 gris.

#### An√°lisis del Problema
Se identific√≥ que algunas alarmas ten√≠an estado `UNKNOWN` en lugar de los estados est√°ndar de CloudWatch:
- La funci√≥n `get_aws_data()` asignaba `'UNKNOWN'` como valor por defecto cuando `StateValue` no exist√≠a
- La funci√≥n `create_alert_bar_html()` no consideraba el estado `UNKNOWN` en el c√°lculo de totales
- Esto causaba discrepancias en los conteos de alarmas

#### Soluci√≥n Implementada
1. **Agregados logs detallados** para debuggear cada alarma individual y su estado
2. **Modificada `create_alert_bar_html()`** para tratar estados `UNKNOWN` como `INSUFFICIENT_DATA`
3. **Actualizada l√≥gica de colores** en `create_server_card()` y `create_group_container()` para considerar estados `UNKNOWN`
4. **Unificado el manejo** de estados desconocidos con estados de datos insuficientes

#### Cambios T√©cnicos
- Estados `UNKNOWN` ahora se suman a `INSUFFICIENT_DATA` en el conteo total
- Las tarjetas de servidor muestran color gris si tienen estados `UNKNOWN` o `INSUFFICIENT_DATA`
- Los grupos tambi√©n consideran estados `UNKNOWN` para determinar su color

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.57 a v0.1.58 para reflejar esta correcci√≥n.

### 2025-09-14 - Correcci√≥n de Enlaces a AWS CloudWatch Console

#### Problema Identificado
Los enlaces de las alarmas en la p√°gina de detalle apuntaban incorrectamente a la propia aplicaci√≥n en lugar de la consola de AWS CloudWatch.

#### Enlaces Incorrectos
```
http://ec2-54-224-75-218.compute-1.amazonaws.com:8501/?poc_vm_id=i-05286b364879c6560#:~:text=EPMAPS%20%2D%20(DMZ%2DSRVSAPROU)%20%2D%20PING%20NOT%20REACHABLE%20%F0%9F%94%97
```

#### Formato Correcto Requerido
```
https://011528297340-pdl6i3zc.us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#alarmsV2:alarm/ALARM_NAME?~(search~'ENCODED_SEARCH')
```

#### Soluci√≥n Implementada
Modificada la funci√≥n `create_alarm_item_html()` en `utils/helpers.py` para:
1. **Extraer cuenta y regi√≥n** del ARN de la alarma
2. **Generar URL correcta** con el formato de la consola AWS
3. **Codificar correctamente** el par√°metro de b√∫squeda
4. **Agregar icono diferente** para alarmas grises (üîí)

#### Cambios T√©cnicos
- Formato de URL: `https://{account_id}-pdl6i3zc.{region}.console.aws.amazon.com/cloudwatch/home?region={region}#alarmsV2:alarm/{alarm_name}?~(search~'{encoded_search}')`
- Codificaci√≥n de caracteres especiales: espacios = `*20`, par√©ntesis = `*28/*29`, etc.
- Icono para estado gris cambiado a üîí

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.58 a v0.1.59 para reflejar esta correcci√≥n.

### 2025-09-14 - Correcci√≥n de Escapado HTML en Enlaces de Alarmas

#### Problema Identificado
Los enlaces de alarmas se generaban con HTML malformado cuando los nombres de alarmas conten√≠an caracteres especiales como `%`, `>`, `<`, causando que el HTML se rompiera y los enlaces no funcionaran correctamente.

**Ejemplo de HTML malformado:**
```
70%')' target='_blank' style='color: white; text-decoration: none; font-weight: 500;'> EPMAPS PRD SRVBOPRD PREVENTIVA CPU % uso >70% üîó
```

#### Causa del Problema
Los nombres de alarmas como `"CPU % uso >70%"` conten√≠an caracteres que tienen significado especial en HTML y no se estaban escapando correctamente antes de insertarlos en el HTML.

#### Soluci√≥n Implementada
1. **Agregado import de m√≥dulo html** para escapado de caracteres
2. **Implementado escapado HTML** usando `html.escape()` en la funci√≥n `create_alarm_item_html()`
3. **Separaci√≥n de contextos**: URL encoding para URLs y HTML escaping para contenido HTML
4. **Aplicado tanto a enlaces como a texto sin enlace**

#### Cambios T√©cnicos
- Import agregado: `import html`
- HTML escaping: `escaped_alarm_name = html.escape(alarm_name)`
- Los caracteres `<`, `>`, `&`, `"`, `'` ahora se escapan correctamente a `&lt;`, `&gt;`, `&amp;`, `&quot;`, `&#x27;`

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.59 a v0.1.60 para reflejar esta correcci√≥n de seguridad y funcionalidad.

### 2025-09-14 - Correcci√≥n Avanzada de URLs de Alarmas con Caracteres Especiales

#### Problema Persistente
A pesar del escapado HTML implementado, persist√≠an problemas con URLs malformadas cuando los nombres de alarmas conten√≠an caracteres como `%`, `>`, causando enlaces rotos con patrones como:
```
80%')' target='_blank' style='color: white; text-decoration: none; font-weight: 500;'> EPMAPS PROD SRVCRMPRD ACTIVA RAM % uso >80% üîó
```

#### An√°lisis Profundo del Problema
1. **Codificaci√≥n de URL insuficiente**: `quote()` no manejaba todos los caracteres especiales
2. **Conflicto de comillas**: Uso de comillas simples en HTML con URLs que conten√≠an comillas
3. **Encodificaci√≥n incompleta**: Faltaban mappings para caracteres como `%`, `>`, `<`, `&`, `=`

#### Soluci√≥n Implementada
1. **Encodificaci√≥n m√°s robusta** del par√°metro de b√∫squeda:
   - `%` ‚Üí `*25`
   - `>` ‚Üí `*3E`
   - `<` ‚Üí `*3C`
   - `&` ‚Üí `*26`
   - `=` ‚Üí `*3D`

2. **URL encoding mejorado** usando `quote(alarm_name, safe='')`

3. **Cambio de formato HTML**:
   - Reemplazado comillas simples (`'`) por comillas dobles (`"`) en atributos HTML
   - Uso de triple comillas simples (`'''`) para strings Python para evitar conflictos

#### Cambios T√©cnicos
- Encodificaci√≥n expandida: `encoded_search = alarm_name.replace(...).replace('%', '*25').replace('>', '*3E')...`
- URL encoding seguro: `quote(alarm_name, safe='')`
- HTML con comillas dobles: `<a href="{console_url}" target="_blank">`

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.60 a v0.1.61 para reflejar esta correcci√≥n avanzada.

### 2025-09-14 - Simplificaci√≥n de Iconos de Estado de Alarmas

#### Cambio Solicitado
El usuario report√≥ que los enlaces funcionan correctamente pero prefiere simplificar los iconos de estado de las alarmas. Los iconos complejos (üî¥, üü°, üîí) causaban confusi√≥n visual.

#### Soluci√≥n Implementada
Simplificaci√≥n de iconos a solo dos estados:
- **üü¢ (Verde)**: Para alarmas en estado normal (OK)
- **‚ö´ (Gris/Negro)**: Para todos los dem√°s estados (ALARM, INSUFFICIENT_DATA, UNKNOWN, etc.)

#### Cambios T√©cnicos
- Modificada funci√≥n `create_alarm_item_html()` en `utils/helpers.py`
- L√≥gica simplificada: `status_icon = "üü¢" if status == "green" else "‚ö´"`
- Eliminados iconos espec√≠ficos por tipo de alarma

#### Beneficios
- **Claridad visual**: Solo dos estados simples de entender
- **Consistencia**: Alineado con el dise√±o general del dashboard
- **Menos confusi√≥n**: No hay necesidad de interpretar m√∫ltiples iconos

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.61 a v0.1.62 para reflejar esta simplificaci√≥n de UI.

### 2025-09-14 - Restauraci√≥n del Esquema de Colores Original

#### Clarificaci√≥n del Usuario
El usuario aclar√≥ que quer√≠a mantener el esquema de colores original con significado espec√≠fico, pero sin iconos complejos como cadenas (üîó) o candados (üîí). Solo c√≠rculos de colores simples.

#### Esquema de Colores Restaurado
- **üü¢ Verde**: Alarmas OK/normales
- **üî¥ Rojo**: Alarmas en estado de alarma (ALARM)
- **üü° Amarillo**: Alarmas preventivas/proactivas (PREVENTIVE/ALERTA)
- **‚ö´ Gris**: Datos insuficientes (INSUFFICIENT_DATA/UNKNOWN)

#### Cambios T√©cnicos
- Restaurada l√≥gica de iconos: `status_icon = "üî¥" if status == "red" else "üü°" if status == "yellow" else "‚ö´" if status == "gray" else "üü¢"`
- Eliminados iconos complejos (üîó, üîí)
- Mantenidos solo c√≠rculos de colores para claridad visual

#### Beneficios
- **Significado claro**: Cada color representa un estado espec√≠fico
- **Simplicidad visual**: Solo c√≠rculos, sin iconos complejos
- **Consistencia**: Alineado con el sistema de colores del dashboard

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.62 a v0.1.63 para reflejar esta restauraci√≥n del esquema de colores.

### 2025-09-14 - Mejoras en M√©tricas de Rendimiento: Gauges y Filtrado de Discos

#### Problemas Identificados
1. **Mensaje confuso de CloudWatch agent**: Aparec√≠a mensaje de "agent no instalado" cuando s√≠ estaba instalado
2. **Discos tmpfs irrelevantes**: Se mostraban sistemas de archivos temporales (tmpfs, devtmpfs, etc.) que no son √∫tiles para monitoreo
3. **Barras de progreso poco visuales**: Las barras simples no proporcionaban suficiente informaci√≥n visual
4. **Umbrales de color inconsistentes**: Los umbrales no segu√≠an est√°ndares de monitoreo

#### Soluciones Implementadas

**1. Filtrado de Sistemas de Archivos**
- Filtrados sistemas de archivos no f√≠sicos: `tmpfs`, `devtmpfs`, `udev`, `proc`, `sys`, `run`
- Solo se muestran discos f√≠sicos reales
- C√≥digo: `if any(exclude in disk_name.lower() for exclude in ['tmpfs', 'devtmpfs', 'udev', 'proc', 'sys', 'run']): continue`

**2. Implementaci√≥n de Gauges**
- Reemplazadas barras de progreso simples por gauges visuales usando Plotly
- Gauges con escala de colores y umbrales claramente definidos
- Layout adaptado: CPU y RAM en columnas superiores, discos en grid de 2 columnas

**3. Estandarizaci√≥n de Umbrales de Color**
- **Verde**: < 80% (normal)
- **Amarillo**: 80-92% (advertencia)
- **Rojo**: > 92% (cr√≠tico)

**4. Mejora de Mensajes de Error**
- Simplificado mensaje cuando no hay datos disponibles
- Eliminada referencia confusa a "CloudWatch Agent no instalado"

#### Cambios T√©cnicos

**Imports agregados:**
```python
import plotly.graph_objects as go
```

**Nueva funci√≥n create_gauge():**
- Gauges con fondos transparentes para tema oscuro
- Escalas de color por zonas
- Indicador threshold para valor actual
- Configuraci√≥n responsive

**Layout actualizado:**
- CPU y RAM: 2 columnas superiores
- Discos: Grid flexible de 2 columnas por fila
- Eliminadas barras de progreso y contenedores de colores manuales

#### Beneficios
- **Visualizaci√≥n mejorada**: Gauges m√°s intuitivos que barras
- **Informaci√≥n relevante**: Solo discos f√≠sicos mostrados
- **Umbrales est√°ndar**: Consistentes con mejores pr√°cticas de monitoreo
- **Experiencia limpia**: Menos ruido visual, mensajes m√°s claros

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.63 a v0.1.64 para reflejar estas mejoras en la visualizaci√≥n de m√©tricas.

### 2025-09-14 - Implementaci√≥n de Monitoreo de Disponibilidad SAP

#### Requerimiento del Usuario
El usuario solicit√≥ agregar una secci√≥n para mostrar m√©tricas de disponibilidad de servicios SAP obtenidas desde archivos de log espec√≠ficos en rutas como `/usr/sap/SERVICIO/CODIGO/work/available.log`.

#### Funcionalidad Requerida
- **Formato de archivos**: `AVAILABLE/UNAVAILABLE FechaInicio FechaFin`
- **Ubicaci√≥n**: Encima de m√©tricas de rendimiento
- **Datos mostrados**: Path, √∫ltimo estado, fecha inicio, fecha fin
- **Historial**: Hasta 10 l√≠neas por servicio

#### Implementaci√≥n Actual (Placeholder)

**Estructura de datos:**
```python
{
    'path': '/usr/sap/ERP/DVEBMGS00/work/available.log',
    'service': 'SAP ERP',
    'instance': 'DVEBMGS00',
    'history': [
        {'status': 'AVAILABLE', 'start_time': '2025-09-14 08:00:00', 'end_time': '2025-09-14 23:59:59'}
    ]
}
```

**Funciones implementadas:**
1. `get_sap_availability_data()`: Identifica servicios SAP por nombre de instancia
2. `create_sap_availability_table()`: Crea tabla visual con estados e historial
3. Integraci√≥n en `display_detail_page()`

**Identificaci√≥n de servicios:**
- **ERP**: Si 'ERP' est√° en el nombre de la instancia
- **CRM**: Si 'CRM' est√° en el nombre de la instancia
- **ISU**: Si 'ISU' est√° en el nombre de la instancia
- **BW**: Si 'BW' est√° en el nombre de la instancia

#### Visualizaci√≥n Implementada
- **T√≠tulo**: üîß Disponibilidad Servicios SAP
- **Por servicio**: Nombre, instancia, path del archivo
- **Estado actual**: Con indicador visual (üü¢/üî¥)
- **Tabla historial**: # | Estado | Fecha Inicio | Fecha Fin
- **Limite**: M√°ximo 10 entradas de historial

#### Pendientes de Implementaci√≥n
**IMPORTANTE**: La implementaci√≥n actual es un placeholder. Se requiere:

1. **M√©todo de acceso a archivos**:
   - SSH/SCP a servidores SAP
   - CloudWatch custom metrics
   - API en servidores SAP
   - Montaje de red (NFS/SMB)

2. **Parser de archivos log**:
   - Leer formato: `AVAILABLE/UNAVAILABLE StartDateTime EndDateTime`
   - Manejo de errores de archivos
   - Cache de datos para performance

3. **Configuraci√≥n**:
   - Mapeo de instancias ‚Üí servicios SAP
   - Credenciales para acceso remoto
   - Rutas de archivos configurables

#### Dependencias Agregadas
- `pandas`: Para manejo de DataFrames en tablas

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.64 a v0.1.65 para reflejar esta nueva funcionalidad.

**Nota**: Esta funcionalidad requiere implementaci√≥n adicional para acceder a los archivos reales. Actualmente muestra datos simulados para demostrar la interfaz.

### 2025-09-14 - Integraci√≥n con CloudWatch Logs para Datos SAP Reales

#### Actualizaci√≥n de Implementaci√≥n
El usuario aclar√≥ que los datos SAP ya se extraen mediante un Lambda y se almacenan en CloudWatch Logs, eliminando la necesidad de acceso directo a archivos.

#### Nueva Implementaci√≥n
Modificada la funci√≥n `get_sap_availability_data()` para consultar CloudWatch Logs usando CloudWatch Logs Insights.

**Componentes implementados:**

1. **Consulta CloudWatch Logs**:
   ```python
   logs_client = get_cross_account_boto3_client_cached('logs')
   query = '''
   fields @timestamp, @message
   | filter @message like /INSTANCE_NAME/
   | filter @message like /AVAILABLE/ or @message like /UNAVAILABLE/
   | sort @timestamp desc
   | limit 10
   '''
   ```

2. **B√∫squeda en m√∫ltiples Log Groups**:
   - `/aws/lambda/sap-availability-checker`
   - `/aws/lambda/sap-monitor`
   - `/epmaps/sap-availability`
   - `/sap/{instance_name}`

3. **Parser de Logs**:
   - Funci√≥n `parse_sap_log_results()` para extraer datos de disponibilidad
   - Manejo de diferentes formatos de log
   - Agrupaci√≥n por servicio SAP

4. **Fallback System**:
   - Si no se encuentran logs reales, usa datos placeholder
   - Logging detallado para debugging
   - Manejo de errores graceful

#### Funcionalidades
- **CloudWatch Logs Insights**: Consultas estructuradas para extraer datos SAP
- **B√∫squeda por instancia**: Filtra logs por nombre de instancia espec√≠fica
- **Historial temporal**: Consulta √∫ltimas 24 horas de datos
- **Parsing flexible**: Adaptable a diferentes formatos de log del Lambda
- **Logging completo**: Debug logs en `/tmp/streamlit_aws_debug.log`

#### Pendiente de Configuraci√≥n
**IMPORTANTE**: Para que funcione completamente, necesitas proporcionar:

1. **Nombre exacto del Log Group** donde el Lambda escribe los datos
2. **Formato de los mensajes de log** del Lambda
3. **Identificadores** usados en los logs para cada servicio SAP

**Ejemplo de formato esperado**:
```
[Timestamp] INSTANCE_NAME SERVICE_NAME AVAILABLE/UNAVAILABLE StartDateTime EndDateTime
```

#### Versi√≥n
Se actualiz√≥ la versi√≥n de v0.1.65 a v0.1.66 para reflejar la integraci√≥n con CloudWatch Logs.
- Dise√±o responsive mantenido con mejoras visuales